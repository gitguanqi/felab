function getRandomNumberByRange(e,t){return Math.round(Math.random()*(t-e)+e)}function getRandomPic(e){let t=Math.ceil(Math.random(0,1)*(e.length-1));return e[t]}function createCanvas(e,t){const i=document.createElement("canvas");return i.width=e,i.height=t,i}function createImg(e,t){const i=new Image;return i.crossOrigin="Anonymous",i.onload=e,i.onerror=(()=>{i.setSrc(getRandomPic(t))}),i.setSrc=function(e){if(isIE){const t=new XMLHttpRequest;t.onloadend=function(e){const t=new FileReader;t.readAsDataURL(e.target.response),t.onloadend=function(e){i.src=e.target.result}},t.open("GET",e),t.responseType="blob",t.send()}else i.src=e},i.setSrc(getRandomPic(t)),i}function createElement(e,t){const i=document.createElement(e);return i.className=t,i}function addClass(e,t){e.classList.add(t)}function removeClass(e,t){e.classList.remove(t)}function getRandomImgSrc(){return getRandomPic()}function draw(e,t,i,n){e.beginPath(),e.moveTo(t,i),e.arc(t+l/2,i-r+2,r,.72*PI,2.26*PI),e.lineTo(t+l,i),e.arc(t+l+r-2,i+l/2,r,1.21*PI,2.78*PI),e.lineTo(t+l,i+l),e.lineTo(t,i+l),e.arc(t+r-2,i+l/2,r+.4,2.76*PI,1.24*PI,!0),e.lineTo(t,i),e.lineWidth=2,e.fillStyle="rgba(255, 255, 255, 0.7)",e.strokeStyle="rgba(255, 255, 255, 0.7)",e.stroke(),e[n](),e.globalCompositeOperation=isIE?"xor":"overlay"}function sum(e,t){return e+t}function square(e){return e*e}const l=42,r=9,w=310,h=155,PI=Math.PI,L=l+2*r+3,isIE=window.navigator.userAgent.indexOf("Trident")>-1;class SlidingValidate{constructor({el:e,onSuccess:t,onFail:i,onRefresh:n,imgLibs:s}){e.style.position="relative",e.style.width=w+"px",Object.assign(e.style,{position:"relative",width:w+"px",margin:"0 auto"}),this.el=e,this.onSuccess=t,this.onFail=i,this.onRefresh=n,this.imgLibs=s}init(){this.initDOM(),this.initImg(),this.bindEvents()}initDOM(){const e=createCanvas(w,h),t=e.cloneNode(!0),i=createElement("div","sliderContainer"),n=createElement("div","refreshIcon"),s=createElement("div","sliderMask"),r=createElement("div","slider"),a=createElement("span","sliderIcon"),o=createElement("span","sliderText");t.className="block",o.innerHTML="向右滑动填充拼图";const l=this.el;l.appendChild(e),l.appendChild(n),l.appendChild(t),r.appendChild(a),s.appendChild(r),i.appendChild(s),i.appendChild(o),l.appendChild(i),Object.assign(this,{canvas:e,block:t,sliderContainer:i,refreshIcon:n,slider:r,sliderMask:s,sliderIcon:a,text:o,canvasCtx:e.getContext("2d"),blockCtx:t.getContext("2d")})}initImg(){const e=createImg(()=>{this.draw(),this.canvasCtx.drawImage(e,0,0,w,h),this.blockCtx.drawImage(e,0,0,w,h);const t=this.y-2*r-1,i=this.blockCtx.getImageData(this.x-3,t,L,L);this.block.width=L,this.blockCtx.putImageData(i,0,t)},this.imgLibs);this.img=e}draw(){this.x=getRandomNumberByRange(L+10,w-(L+10)),this.y=getRandomNumberByRange(10+2*r,h-(L+10)),draw(this.canvasCtx,this.x,this.y,"fill"),draw(this.blockCtx,this.x,this.y,"clip")}clean(){this.canvasCtx.clearRect(0,0,w,h),this.blockCtx.clearRect(0,0,w,h),this.block.width=w}bindEvents(){this.el.onselectstart=(()=>!1),this.refreshIcon.onclick=(()=>{this.reset(),"function"==typeof this.onRefresh&&this.onRefresh()});let e,t,i=[],n=!1;const s=function(i){e=i.clientX||i.touches[0].clientX,t=i.clientY||i.touches[0].clientY,n=!0},r=s=>{if(!n)return!1;const r=s.clientX||s.touches[0].clientX,a=s.clientY||s.touches[0].clientY,o=r-e,l=a-t;if(o<0||o+38>=w)return!1;this.slider.style.left=o+"px";const c=(w-40-20)/(w-40)*o;this.block.style.left=c+"px",addClass(this.sliderContainer,"sliderContainer_active"),this.sliderMask.style.width=o+"px",i.push(l)},a=t=>{if(!n)return!1;n=!1;const s=t.clientX||t.changedTouches[0].clientX;if(s==e)return!1;removeClass(this.sliderContainer,"sliderContainer_active"),this.trail=i;const{spliced:r,verified:a}=this.verify();r?a?(addClass(this.sliderContainer,"sliderContainer_success"),"function"==typeof this.onSuccess&&this.onSuccess()):(addClass(this.sliderContainer,"sliderContainer_fail"),this.text.innerHTML="再试一次",this.reset()):(addClass(this.sliderContainer,"sliderContainer_fail"),"function"==typeof this.onFail&&this.onFail(),setTimeout(()=>{this.reset()},1e3))};this.slider.addEventListener("mousedown",s),this.slider.addEventListener("touchstart",s),document.addEventListener("mousemove",r),document.addEventListener("touchmove",r),document.addEventListener("mouseup",a),document.addEventListener("touchend",a)}verify(){const e=this.trail,t=e.reduce(sum)/e.length,i=e.map(e=>e-t),n=Math.sqrt(i.map(square).reduce(sum)/e.length),s=parseInt(this.block.style.left);return{spliced:Math.abs(s-this.x)<10,verified:0!==n}}reset(){this.sliderContainer.className="sliderContainer",this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.img.setSrc(getRandomPic(this.imgLibs))}}window.SlidingValidate={init:function(e){return new SlidingValidate(e).init()}};